#include "gd32e10x.h"#include "hardware.h"#include "iwdg.h"#include "usart.h"#include "stdio.h"#include "systick.h"#include "GSM234G.h"#include "config.h"#include "Adc.h"#include "rtc.h"#include "spi.h"#include "spi_flash.h"#include "enc28j60.h"#include "sx127x_Hal.h"#include "tim1.h"#include "string.h"#include "timer.h"#include "tim2.h"#include "loraDealDat.h"#include "dealDat.h"#include "stdlib.h"#include "EthNet.h"#include "netLink.h"#include "pub.h"u8 ChipId[4];const u8 HEX[] = {'0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'};//型号u8 version[7] = "xGMode";u8 NetLedCnt = 0;u8 LoraLedCnt = 0;u16 GprsLedCnt = 1;u8 GprsLedStart = 1;u8 GprsLedEnd = 1;u8 DB_Flag = 1;u8 UpdateTime = 1;/*所有中断分子设置 以及优先级*/void InitNVIC(void){	nvic_priority_group_set(NVIC_PRIGROUP_PRE2_SUB2);	nvic_irq_enable(USART0_IRQn,2,2);	nvic_irq_enable(USART1_IRQn,2,0);	nvic_irq_enable(ADC0_1_IRQn,3,3);	nvic_irq_enable(RTC_IRQn,0,1);	nvic_irq_enable(TIMER1_IRQn,0,2);	nvic_irq_enable(TIMER2_IRQn,1,0);}/* 所使用的GPIO设置 */void InitGPIO(void){	rcu_periph_clock_enable(RCU_GPIOA);	rcu_periph_clock_enable(RCU_GPIOB);		gpio_init(GPIOA,GPIO_MODE_AIN,GPIO_OSPEED_10MHZ,GPIO_PIN_0);	gpio_init(GPIOA,GPIO_MODE_OUT_PP,GPIO_OSPEED_10MHZ,GPIO_PIN_4 | GPIO_PIN_8 | GPIO_PIN_11);	gpio_init(GPIOA,GPIO_MODE_IPU,GPIO_OSPEED_10MHZ,GPIO_PIN_12);		gpio_init(GPIOB,GPIO_MODE_IPU,GPIO_OSPEED_10MHZ,GPIO_PIN_1 | GPIO_PIN_8);	gpio_init(GPIOB,GPIO_MODE_OUT_PP,GPIO_OSPEED_10MHZ,	GPIO_PIN_2 | GPIO_PIN_10 |		GPIO_PIN_12 | GPIO_PIN_13 | GPIO_PIN_14 | GPIO_PIN_15);		LORACS_H	ENC28J60CS_H	FLASHCS_H}/* 获取芯片唯一ID*/void GetChipId(void){	u8 *ptr;	ptr = (u8*)0x1FFFF7E8;	ChipId[0] = *ptr++;	ChipId[1] = *ptr++;	ChipId[2] = *ptr++;	ChipId[3] = *ptr;}/*	使用串口1 发送数据*/void PutInUart0(u8 dat){	while((TxCnt0 + TxPtr0) >= SENDBUFF_MAX)	{//要发送的数据大于最大发送字节 需要等待数据发送后 再能将数据存放在buf中		//等待中需要进行喂狗		WatchDogFeed();	}	usart_interrupt_disable(USART0,USART_INT_TBE);	TxBuffer0[(TxCnt0 + TxPtr0) & (SENDBUFF_MAX - 1)] = dat & 0xFF;	TxCnt0++;	usart_interrupt_enable(USART0,USART_INT_TBE);}/*	使用串口2 发送数据*/void PutInUart1(u8 dat){	//控制寄存器 使能位判断	if((USART_CTL0(USART1) & 0x2000) == 00)	{		return;	}	while((TxCnt1 + TxPtr1) >= SENDBUFF_MAX)	{//要发送的数据大于最大发送字节 需要等待数据发送后 再能将数据存放在buf中		//等待中需要进行喂狗		WatchDogFeed();	}	usart_interrupt_disable(USART1,USART_INT_TBE);	TxBuffer1[(TxCnt1 + TxPtr1) & (SENDBUFF_MAX - 1)] = dat & 0xFF;	TxCnt1++;	usart_interrupt_enable(USART1,USART_INT_TBE);}/*	串口0发送字符串*/void SendString(u8 *buf){	u16 i = 0;	while(buf[i] != '\0')	{		PutInUart0(buf[i++]);	}}/*	开启GSM模块*/u8 OpenGSM(void){	u8 i = 0;	InitUsart1(115200);	TxCnt1 = 0;	TxPtr1 = 0;	GSMPWRON	delay_1ms(4000);	for(i = 0; i < 5; i++)	{		if(CheckAt())		{			break;		}	}	if(i >= 5)	{		S282_Log("AT ERR");		return 1;	}	return 0;}/* 关闭GSM模块*/void CloseGSM(void){	GSMPWROFF	usart_disable(USART1);}/*	重启GSM模块*/void RestartGSM(void){	CloseGSM();	g_flag = 0;	OpenGSM();		if(GSMInit())	{//只有AT测试成功才会进行初始化//		CloseGSM();		g_flag = 0;	}	}/*	比较指定长度的字符	1相等  0不相等*/u8 CompStr(u8 *str1,u8 *str2,u8 len){	for(u8 i = 0; i < len; i++,str1++,str2++)	{		if(!ISVALIDCHAR(*str2))		{//不是可用的字符 退出  比较结束			break;		}		if(*str1 != *str2)		{			return 0;		}	}	return 1;}/*	将str2的数据存放在str1中*/u8 CopyStr(u8 *str1,u8 *str2,u8 DataLen){	u8 len = 0;	for( ; len < DataLen;str1++,str2++,len++)	{		if(!ISVALIDCHAR(*str2))		{			*str1 = '\0';			break;		}		*str1 = *str2;	}		return len;}/*	字符转数字*/u16 StrToNum(u8 *str){	u16 dat = 0;	for(u8 i = 0; i < 5; i++)	{		if(!ISNUM(str[i]))		{			break;		}		dat = dat * 10 + str[i] - 0x30;	}	return dat;}/*	数字转字符*/u8 NumToStr(u8 *str1,u16 num){	u8 len = 0;		str1[len++] = num / 10000 + 0x30;	str1[len++] = num / 1000 % 10 + 0x30;	str1[len++] = num / 100 % 10 + 0x30;	str1[len++] = num / 10 % 10 + 0x30;	str1[len++] = num % 10 + 0x30;		return len;}/*	校验IP地址是否可用	可用返回1*/u8 IsIPaVailable(u8 *TarIp){	u8 i,dot=0,dat;		for(i = 0; i < 32; i++)	{		dat = *(u8*)(TarIp + i);				if(dat < 0x20 || dat > 0x7e )		{			break;//到结束		}		if(dat == '.') 		{			dot++;//小数点数量		}		if(!ISNUM(dat) && (dat != '.'))//有非数字		{			return 0;		}	}	if(dot == 3)	{		return 1;	}	return 0;}/*	初始化*/void TotalInit(void){	InitNVIC();	InitGPIO();	GetChipId();	RTCInit();	InitUsart0(115200);	delayMs(2);	W25Q_Init();	InitTimer1(400 - 1,999); //10ms	InitAdc();	SysInfoInit();	tempWorkfreq = SysInfo.Workfreq;	WatchDogInit();		if(UserInfo.isReboot == 0x1234)	{//重启		UserInfo.isReboot = 0x11;		SendString("TRUE");		SaveUserInfo();	}	NETLED_ENABLE;		RFLED_ENABLE;	GPRSLEDON;	PWRLEDON	printf("\r\n\r\n");	printf("/************************************/\r\n");	printf("/*   WWW.4G-IOT.COM copyright 2021  */\r\n");	printf("/*       All rights Reserved        */\r\n");	printf("/*    king Pigeon Hi-Tech.Co.,ltd.  */\r\n");	printf("/*       Device %s*/\r\n",UserInfo.version);	printf("/*    latest build @ %s    */\r\n",__DATE__);	printf("/************************************/\r\n");	NetSelected = SysInfo.NetLinkPriority;	GPRSLEDOFF;		InitNet();	Tim2Init();	//50ms  终端设备上报同步计数值	OpenGSM();	GSMInit();}/*	获取设备信息*/void DebugSysInfo(void){	u8 *buf = malloc(128);		sprintf((char*)buf,"{\"MSGTYPE\":4,\"MSG\":{");	SendString(buf);	sprintf((char*)buf,"\r\n\"deviceId\":%d,\"password\":\"",SysInfo.DeviceId);	SendString(buf);	for(u8 i = 0;i < 4; i++)	{		sprintf((char*)&buf[i],"%c",SysInfo.PassCode[i]);	}	SendString(buf);	sprintf((char*)buf,"\r\n\",\"DeviceName\":\"%s\",",SysInfo.DeviceName);	SendString(buf);	sprintf((char*)buf,"\r\n\"GprsMode\":%d,\"GprsApn\":\"%s\",",SysInfo.GprsMode,SysInfo.GprsApn);	SendString(buf);	sprintf((char*)buf,"\r\n\"GprsUsr\":\"%s\",\"GprsPwd\":\"%s\",",SysInfo.GprsUsr,SysInfo.GprsPwd);	SendString(buf);	sprintf((char*)buf,"\r\n\"GprsIP\":\"%s\",\"GprsPort\":%d,",SysInfo.GprsServerIP,SysInfo.GprsServerPort);	SendString(buf);	sprintf((char*)buf,"\r\n\"GprsBeatHeart\":%d,\"GprsFreeOffline\":%d,",SysInfo.GprsBeatHeart,SysInfo.GprsFreeOffline);	SendString(buf);	sprintf((char*)buf,"\r\n\"GprsRetryCnt\":%d,",SysInfo.GprsRetryCnt);	SendString(buf);	sprintf((char*)buf,"\r\n\"GprsRegDat\":\"%s\",\"GprsServerAckReg\":\"%s\",",SysInfo.GprsRegDat,SysInfo.GprsServerAckReg);	SendString(buf);	sprintf((char*)buf,"\r\n\"GprsServerKickOff\":\"%s\",\"GprsHeartCont\":\"%s\",",SysInfo.GprsServerKickOff,SysInfo.GprsHeartCont);	SendString(buf);	sprintf((char*)buf,"\r\n\"GprsServerAckHeart\":\"%s\",\"GprsRegMode\":%d,",SysInfo.GprsServerAckHeart,SysInfo.GprsRegMode);	SendString(buf);	sprintf((char*)buf,"\r\n\"GprsDatType\":%d,\"Rj45Mode\":%d,\"Dhcp\":%d,",SysInfo.GprsDatType,SysInfo.Rj45Mode,SysInfo.Dhcp);	SendString(buf);	sprintf((char*)buf,"\r\n\"LocalIp\":\"%d.%d.%d.%d\",\"LocalPort\":%d,",		SysInfo.LocalIp[0],SysInfo.LocalIp[1],SysInfo.LocalIp[2],SysInfo.LocalIp[3],SysInfo.LocalPort);	SendString(buf);	sprintf((char*)buf,"\r\n\"SubNetMask\":\"%d.%d.%d.%d\",",SysInfo.SubNetMask[0],SysInfo.SubNetMask[1],SysInfo.SubNetMask[2],SysInfo.SubNetMask[3]);	SendString(buf);	sprintf((char*)buf,"\r\n\"GateIp\":\"%d.%d.%d.%d\",",SysInfo.GateIp[0],SysInfo.GateIp[1],SysInfo.GateIp[2],SysInfo.GateIp[3]);	SendString(buf);	sprintf((char*)buf,"\r\n\"DNSIP1\":\"%d.%d.%d.%d\",",SysInfo.DnsIp1[0],SysInfo.DnsIp1[1],SysInfo.DnsIp1[2],SysInfo.DnsIp1[3]);	SendString(buf);	sprintf((char*)buf,"\r\n\"DNSIP2\":\"%d.%d.%d.%d\",",SysInfo.DnsIp2[0],SysInfo.DnsIp2[1],SysInfo.DnsIp2[2],SysInfo.DnsIp2[3]);	SendString(buf);	sprintf((char*)buf,"\r\n\"EthTarIP\":\"%s\",\"EthTarTCPPort\":%d,",SysInfo.EthTarIP,SysInfo.EthTarTcpPort);	SendString(buf);	sprintf((char*)buf,"\r\n\"EthBeatHeart\":%d,\"EthFreeoffline\":%d,",SysInfo.EthBeatHeart,SysInfo.EthFreeOffline);	SendString(buf);	sprintf((char*)buf,"\r\n\"EthDatType\":%d,\"EthRetryCnt\":%d,",SysInfo.EthDatType,SysInfo.EthRetryCnt);	SendString(buf);	sprintf((char*)buf,"\r\n\"EthRegDat\":\"%s\",\"EthServerAckReg\":\"%s\",",SysInfo.EthRegDat,SysInfo.EthServerAckReg);	SendString(buf);	sprintf((char*)buf,"\r\n\"EthServerKickOff\":\"%s\",\"EthHeartCont\":\"%s\",",SysInfo.EthServerKickOff,SysInfo.EthHeartCont);	SendString(buf);	sprintf((char*)buf,"\r\n\"EthServerAckHeart\":\"%s\",\"EthRegMode\":%d,",SysInfo.EthServerAckHeart,SysInfo.EthRegMode);	SendString(buf);	sprintf((char*)buf,"\r\n\"MqttSubTopic\":\"%s\",\"MqttPubtopic\":\"%s\",",SysInfo.MqttSubTopic,SysInfo.MqttPubTopic);	SendString(buf);	sprintf((char*)buf,"\r\n\"MqttDeviceId\":\"%s\",\"MqttUserName\":\"%s\",",SysInfo.MqttDeviceID,SysInfo.MqttUserName);	SendString(buf);	sprintf((char*)buf,"\r\n\"MqttPwd\":\"%s\",",SysInfo.MqttPwd);	SendString(buf);	sprintf((char*)buf,"\r\n\"MqttRepTim\":%d,\"MqttRepData\":%d,",SysInfo.MqttRepTim,SysInfo.MqttRepData);	SendString(buf);	sprintf((char*)buf,"\r\n\"AliyunSet\":%d,\"ProductKey\":\"%s\",",SysInfo.AliyunSet,SysInfo.ProductKey);	SendString(buf);	sprintf((char*)buf,"\r\n\"DeviceName_Could\":\"%s\",\"DeviceSecret\":\"%s\",",SysInfo.DeviceName_Could,SysInfo.DeviceSecret);	SendString(buf);		sprintf((char*)buf,"\r\n\"HWDevId\":\"%s\",\"HWSerId\":\"%s\",",SysInfo.HWDevId,SysInfo.HWSerId);	SendString(buf);	sprintf((char*)buf,"\r\n\"HWServer\":\"%s\",\"HWDevSecret\":\"%s\",",SysInfo.HWServer,SysInfo.HWDevSecret);	SendString(buf);		sprintf((char*)buf,"\r\n\"Workfreq\":%d,\"TerminalRepCycle\":%d,",tempWorkfreq,SysInfo.TerminalRepCycle);	SendString(buf);	sprintf((char*)buf,"\"NetLinkPriority\":%d,\"Language\":%d,",SysInfo.NetLinkPriority,UserInfo.isChinese);	SendString(buf);	sprintf((char*)buf,"\"deviceMode\":\"%s\",\"version\":\"%s\",",UserInfo.version,version);	SendString(buf);	sprintf((char*)buf,"\"imei\":\"%s\",\"siglevel\":%d,\"bat\":%d,",g_IMEI,g_SigLevel,LocalBatVal);	SendString(buf);	if(DET5V)	{		sprintf((char*)buf,"\"det5V\":1,");	}	else	{		sprintf((char*)buf,"\"det5V\":0,");	}	SendString(buf);	sprintf((char*)buf,"\"year_month_day\":\"%d-%d-%d\",",			calendar.w_year,calendar.w_month,calendar.w_day);	SendString(buf);	sprintf((char*)buf,"\"hour_min_sec\":\"%d:%d:%d\",\"week\":\"%d\"}}",			calendar.hour,calendar.min,calendar.sec,calendar.week);	SendString(buf);		free(buf);}/*	读取设备ID为index 的终端设备信息	W2为: WT107,108,109,102信息	mode 0仅读数据信息  1 读取设备寄存器数据*/void GetTerminalW2Info(u8 Index,u8 mode,u8 isLast){ 	u8 *buf = malloc(128);		sprintf((char*)buf,"{\"MSGTYPE\":4,\"MSG\":{");	SendString(buf);	//设备ID  设备名称	sprintf((char*)buf,"\"DeviceID\":%d,\"DevName\":\"%s\",\"MAC\":\"%s\",",DevInfo[Index].deviceId,DevInfo[Index].devName,DevInfo[Index].uniId);	SendString(buf);					//设备描述 温度 湿度 光照度 CO2浓度 CTOV 土壤水分  土壤温度	sprintf((char*)buf,"\"Describe1\":\"%s\",\"Describe2\":\"%s\",",DevInfo[Index].name[0],DevInfo[Index].name[1]);	SendString(buf);	sprintf((char*)buf,"\"Describe3\":\"%s\",\"Describe4\":\"%s\",",DevInfo[Index].name[2],DevInfo[Index].name[3]);	SendString(buf);	sprintf((char*)buf,"\"Describe5\":\"%s\",\"Describe6\":\"%s\",",DevInfo[Index].name[4],DevInfo[Index].name[5]);	SendString(buf);	sprintf((char*)buf,"\"Describe7\":\"%s\",",DevInfo[Index].name[6]);	SendString(buf);	//设备类型	sprintf((char*)buf,"\"Type\":%d,\"IsExist\":%d,",DevInfo[Index].Type,DevInfo[Index].isExist);	SendString(buf);		sprintf((char*)buf,"\"HighLim\":{\"temp\":%d,\"humi\":%d,\"illu\":%d,\"co2\":%d,\"tvoc\":%d,\"soilHumi\":%d,\"soilTemp\":%d},",		DevInfo[Index].HighLim[0],DevInfo[Index].HighLim[1],DevInfo[Index].HighLim[2],DevInfo[Index].HighLim[3],		DevInfo[Index].HighLim[4],DevInfo[Index].HighLim[5],DevInfo[Index].HighLim[6]);	SendString(buf);		sprintf((char*)buf,"\"LowLim\":{\"temp\":%d,\"humi\":%d,\"illu\":%d,\"co2\":%d,\"tvoc\":%d,\"soilHumi\":%d,\"soilTemp\":%d}",		DevInfo[Index].LowLim[0],DevInfo[Index].LowLim[1],DevInfo[Index].LowLim[2],		DevInfo[Index].LowLim[3],DevInfo[Index].LowLim[4],DevInfo[Index].LowLim[5],DevInfo[Index].LowLim[6]);	SendString(buf);		if(mode == 1)	{		sprintf((char*)buf,",\"Temp\":%d,",DevRegVal[Index * 7]);		switch(DevInfo[Index].Type)		{			case DEV_WT103:			case DEV_WT104:			case DEV_WT105:			case DEV_WT106:			case DEV_WT107:			case DEV_WT110:			case DEV_WT111:				if(DevRegVal[Index * 7] & 0x8000)				{					sprintf((char*)buf,",\"Temp\":%d,",0 - (DevRegVal[Index * 7] & 0x7F));				}				break;		}				SendString(buf);		//设备描述 温度 湿度 光照度 土壤水分 CO2浓度		sprintf((char*)buf,"\"Humi\":%d,\"Illu\":%d,",DevRegVal[Index * 7 + 1],DevRegVal[Index * 7 + 2]);		SendString(buf);		sprintf((char*)buf,"\"Co2\":%d,\"Tvoc\":%d,",DevRegVal[Index * 7 + 3]			,DevRegVal[Index * 7 + 4]);		SendString(buf);		sprintf((char*)buf,"\"SoilTemp\":%d,",DevRegVal[Index * 7+ 5]);		if(DevInfo[Index].Type == DEV_WT107)		{				if(DevRegVal[Index * 7 + 5] & 0x8000)				{					sprintf((char*)buf,"\"SoilTemp\":%d,",0 - (DevRegVal[Index * 7+ 5] & 0x7F));				}		}		SendString(buf);		sprintf((char*)buf,"\"SoilHumi\":%d,\"isLast\":%d",DevRegVal[Index * 7 + 6],isLast);		SendString(buf);	}	sprintf((char*)buf,"}}");	SendString(buf);	free(buf);}/*	获取是否存在下一个设备信息*/u8 GetDevOnlineIndex(u8 *ptr,u8 *nextPtr){	u8 i,j,isLast = 0;	for(i = *ptr; i < DEVICE_MAX; i++)	{		if(DevInfo[i].isExist && DevInfo[i].deviceId <= DEVICE_MAX)		{			*ptr = i;			for(j = i + 1; j < DEVICE_MAX; j++)			{				if(DevInfo[j].isExist && DevInfo[j].deviceId <= DEVICE_MAX && DevInfo[j].deviceId > 0)				{					*nextPtr = j;					break;				}			}			if(j >= DEVICE_MAX)			{				isLast = 1;			}			if(i == 0 && isLast == 1)			{//设备在线只有一个 且下标为0				*nextPtr = 1;			}			break;		}	}	if(i >=DEVICE_MAX)	{//一个在线设备都没有		isLast = 1;	}	return isLast;}void GPRSLEDShow(void){	switch(ModuleVer)	{		case '2':			if(g_SigLevel == 0)			{//无信号 快闪 灭0.8s 亮0.2s				GprsLedEnd = 80;				GprsLedStart = 20;			}			else			{//正常 慢闪 灭2s 亮0.2				GprsLedEnd = 200;				GprsLedStart = 20;			}		break;		case '3':		case '4':			if(g_SigLevel == 0)			{//无信号 快闪 灭1 闪 0.8				GprsLedEnd = 100;				GprsLedStart = 180;			}			else			{//正常 慢闪 灭2s 闪 1				GprsLedEnd = 200;				GprsLedStart = 100;			}		break;		default:				GprsLedEnd = 1;				GprsLedStart = 1;			break;	}	}/*	SET UTC 时间*/void SetUtcTime(u8 *str){	u8 i;	u8 year,mon,day,hour,min,sec;	u8 *dateFram = malloc(40);	for(i = 0; i < 10; i++)	{		if(str[i] == '-')		{			CopyStr(dateFram,&str[i - 2],40);			break;		}	}	if(i >= 10)	{		return;	}	year = StrToNum(&dateFram[0]);	mon = StrToNum(&dateFram[3]);	day = StrToNum(&dateFram[6]);	hour = StrToNum(&dateFram[9]);	min = StrToNum(&dateFram[12]);	sec = StrToNum(&dateFram[15]);	printf("%d:%d:%d,%d-%d-%d\r\n",hour,min,sec,year,mon,day);	UpdateTime = 0;	RTC_Set(year,mon,day,hour,min,sec);	free(dateFram);}/*	获取系统计时数*/u32 GetSysTimCnt(void){	if(SysTimCnt > 100000)	{		SysTimCnt = 0;	}	return SysTimCnt;}/*	获取当前秒数*/u16 GetSecCnt(void){	u8 hour = calendar.hour;	u8 min = calendar.min;	u8 sec = calendar.sec;	return (hour * 3600 + min * 60 + sec);}/*	检测是否硬件重启 按键3秒重置	电源灯闪烁3秒*/void CheckRefactory(void){	static u16 pressTim = 0;	static u8 pressRel = 1;	if(KEYRST)	{//按键按下		if(pressRel == 1)		{//第一进来 获取当前时间			pressTim = GetSecCnt();			pressRel = 0;		}		if(ABSVALUE(GetSecCnt(),pressTim) > 2)		{//大于3s			SetSysInfoDef();			pressTim = 0;						for(u8 i = 0; i < 3; i++)			{//闪烁5次				PWRLEDOFF				NETLEDOFF				RFLEDOFF				GPRSLEDOFF				delayMs(200);				PWRLEDON				NETLEDON				RFLEDON				GPRSLEDON				delayMs(200);			}			NVIC_SystemReset();		}	}	else	{		pressRel = 1;		pressTim = 0;	}	}/*	检测电源状态 	当电源低于3.6v进行关机操作*/void CheckPower(void){	static u16 batLowTimCnt = 0;					//低电源计数值	static u16 batAlarmTimCnt = 0;				//低电源预警计数值	if(!DET5V)	{//直充电源关闭了		PWRLEDOFF		if(LocalBatVal < 3351)		{//当前电压小于3.6V 实际值 (3600 * 4096 * 3 / 4 / 3300)			batLowTimCnt++;			if(batLowTimCnt > 60000)			{				//关闭SPI  网络 GPRS Lora 不工作				FLASHCS_L;				SpiClose();				CloseGSM();				gpio_init(GPIOA,GPIO_MODE_IPU,GPIO_OSPEED_50MHZ,GPIO_PIN_5 | GPIO_PIN_7);								while(1)				{					//低功耗睡眠 等待中断产生					__WFI();										WatchDogFeed();					if(DET5V)					{//等待外部电源 重启设备						NVIC_SystemReset();					}				}							}		}		else if(LocalBatVal < 3397)		{//电源低 预警  实际值 (3650 * 4096 * 3 / 4 / 3300)			batLowTimCnt = 0;			batAlarmTimCnt++;		}		else		{			batLowTimCnt = 0;			batAlarmTimCnt = 0;		}			}	else	{		PWRLEDON		batLowTimCnt = 0;		batAlarmTimCnt = 0;	}}/*	校验密码*/void ChekPwd(void){	for(u8 i = 0; i < 4; i++)	{		if(!(SysInfo.PassCode[i] >= 0x30 && SysInfo.PassCode[i] <= 0x39))		{			ReadSysInfo();		}	}}/*	判断当前时间是否可以发送一次数据	设备上报时间(最小,最大)  40 * (Id - 1)  -- 40 * Id - 20	下发设置时间(最小,最大)	 40 * Id - 20 	 -- 40 + 40 * Id*/void JudgeDevSendTim(void){	u8 tempId;	tempId = RepCnt % 40 != 0 ? RepCnt % 2400 / 40 + 1 : RepCnt % 2400 / 40;	if(tempId >= DEVICE_MAX)	{//满足直接发送条件		return;	}	if(RepCnt > tempId * 40 - 12)	{//当前空闲时间不足以发送数据 等待下一次空闲		tempId += 1;	}		if(DevInfo[tempId-1].deviceId == 0 || DevInfo[tempId-1].deviceId > DEVICE_MAX)	{//不存在终端设备ID  直接发送		return;	}		//当前计数值 小于设备上报最大时间  进行等待	while(RepCnt < (tempId * 40 - 27))	{//等待一次数据接收结束		if(LoraPro())		{			break;		}		WatchDogFeed();	}}/*	日志打印16进制*/void S282_LogInt(u8 *str1,u8 len){	if(DB_Flag == 1)	{		printf("%s:%d\r\n",str1,len);	}}/*	S282日志打印*/void S282_Log(u8 *str){	if(DB_Flag == 1)	{		printf("%s\r\n",str);	}}