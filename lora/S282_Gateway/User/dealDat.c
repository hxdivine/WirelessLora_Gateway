#include "stdio.h"#include "stdlib.h"#include "string.h"#include "dealDat.h"#include "usart.h"#include "config.h"#include "hardware.h"#include "iwdg.h"#include "rtc.h"#include "GSM234G.h"#include "loraDealDat.h"#include "EthNet.h"#include "netLink.h"#include "pub.h"#define READ_ALL			  0x2A#define SET_ALL				  0x3F#define	READ_TIME			  0x01#define SET_TIME			  0x02#define SET_PWD				  0x03#define READ_VER			  0x04#define RESTART				  0x10#define SET_RST				  0x11#define SET_DEVONLINE	  0x42#define READ_DEV				0x65#define SET_DEV					0x66#define DEL_DEV					0x67#define SET_DEVALL			0x72#define READ_DEVALL			0x68#define READ_DEVREG			0x69#define STOP_DEVREG			0x6A#define SET_DEVWT1			0x6C#define READ_HIS				0x6E#define CLEAR_HIS				0x6F#define READ_ALARM			0x70#define CLEAR_ALARM			0x71#define SET_MSG					0x40#define READ_MSG				0x41#define SET_VER					0x48//全局数据bufOVER_ALLDATA_FRAME overAllData_Fram;//工作频段更改标志u8 freqChangeFlag = 0;//记录更改时间u8 freqChangeTim = 0;//频段更改设置 频段更改后 在一个周期内保存原有频段(需要更新每个终端设备的频段)u8 tempWorkfreq = 0;u32 DevDBTime = 0;/*	设置成功回显*/void ReplySetOK(void){	usart_Frame.recLen = 0;	sprintf((char*)usart_Frame.recBuf,"TRUE\r\n");	usart_Frame.sendFlag = 1;	}/*	设置失败回显*/void ReplySetErr(){	usart_Frame.recLen = 0;	sprintf((char*)usart_Frame.recBuf,"FALSE\r\n");	usart_Frame.sendFlag = 1;	}/*	获取设备时间*/void ReplyDeviceTim(void){	//PC端	usart_Frame.recLen = 0;	usart_Frame.recLen = sprintf((char*)usart_Frame.recBuf,"{\"MSGTYPE\":4,\"MSG\":{");	usart_Frame.recLen += sprintf((char*)&usart_Frame.recBuf[usart_Frame.recLen],"\"year_month_day\":\"%d-%d-%d\",\r\n",			calendar.w_year,calendar.w_month,calendar.w_day);	usart_Frame.recLen += sprintf((char*)&usart_Frame.recBuf[usart_Frame.recLen],"\"hour_min_sec\":\"%d:%d:%d\",\r\n",			calendar.hour,calendar.min,calendar.sec);	usart_Frame.recLen +=sprintf((char*)&usart_Frame.recBuf[usart_Frame.recLen],"\"week\":\"%d\"}}\r\n",calendar.week);	usart_Frame.sendFlag = 1;}/*	设置设备密码*/void SetDevicePwd(u8 *InBuf){	u8 i;	for(i = 0; i < 4; i++)	{		if(!ISASCCHAR(InBuf[i]))		{			break;		}	}	if(i < 4)	{		ReplySetErr();		return;	}	SysInfo.PassCode[0] = InBuf[0];	SysInfo.PassCode[1] = InBuf[1];	SysInfo.PassCode[2] = InBuf[2];	SysInfo.PassCode[3] = InBuf[3];	SaveSysInfo();	ReplySetOK();}/*	设置设备时间*/void SetDeviceTime(u8 *InBuf){	u8 year;	u8 month;	u8 day;	u8 hour;	u8 min;	u8 sec;		year = (InBuf[0] - '0') * 10 + InBuf[1] - '0';	month = (InBuf[2] - '0') * 10 + InBuf[3] - '0';	day = (InBuf[4] - '0') * 10 + InBuf[5] - '0';	hour = (InBuf[6] - '0') * 10 + InBuf[7] - '0';	min = (InBuf[8] - '0') * 10 + InBuf[9] - '0';	sec = (InBuf[10] - '0') * 10 + InBuf[11] - '0';		RTC_Set(year,month,day,hour,min,sec);	RTC_Get();}/*	获取字符串位置*/u8 SetCopyStr(u8 *InBuf,u8 *str,u8 maxLen){	u8 i;	for(i = 0; i < maxLen; i++)	{		if(InBuf[i] == ',')		{			if(InBuf[i + 1] == ';' && InBuf[i + 2] == '>')			{				str[i] = '\0';				break;			}			str[i] = '\0';			break;		}				str[i] = InBuf[i];	}		i += 1;		return i;}/*	获取特定字符串位置*/u8 SetOnlyCopyStr(u8 *InBuf,u8 *str,u8 maxLen){	u8 i;	for(i = 0; i < maxLen; i++)	{		if(InBuf[i] == ',')		{			if(InBuf[i + 1] == ';' && InBuf[i + 2] == '>')			{				str[i] = '\0';				break;			}		}				str[i] = InBuf[i];	}		i += 3;		return i;}/*	获取数字 以及返回的长度*/u8 SetCopyNum(u8 *InBuf,u32 *str){	u8 i = 0,sign = 0;	*str = 0;	if(InBuf[0] == '-')	{		sign = 1;		i = 1;	}	for(; i < 10; i++)	{		if(InBuf[i] == ',')		{			break;		}		*str = (*str) * 10 + InBuf[i] - '0';	}	if(sign == 1)	{		*str |= 0x8000;	}	i += 1;	return i;}/*	获取IP地址*/u8 SetCopyIp(u8 *InBuf,u8 *ip){	u8 i = 0;	u8 j = 0;	u8 ipDat = 0;	for(i = 0; i < 17; i++)	{		if(InBuf[i] == ',')		{			ip[j] = ipDat;			break;		}		if(InBuf[i] == '.')		{			ip[j++] = ipDat;			ipDat = 0;			continue;		}		ipDat = ipDat * 10 + InBuf[i] - '0';	}	i++;	return i;}u8 SaveIntData(u8 *InBuf,u8 *str,u32 *data,u16 *len,u8 addLen){	if(CompStr(InBuf,str,addLen))	{		*len += addLen;		*len += SetCopyNum(&InBuf[addLen],data);		return 0;			}	return 1;}	u8 SaveStrData(u8 *InBuf,u8 *str,u8 *data,u8 maxLen,u16 *len,u8 addLen){	if(CompStr(InBuf,str,addLen))	{		*len += addLen;		*len += SetCopyStr(&InBuf[addLen],data,maxLen);		return 0;			}	return 1;}/*	写入设备参数*/u8 SetDevicePara(u8 *InBuf){	u16 len = 0;	ClearSysInfo();	//deviceId:	if(SaveIntData(&InBuf[len],"deviceId:",(u32*)&SysInfo.DeviceId,&len,9))	{		goto ANALYDATAEND;	}		//DeviceName:	if(CompStr(&InBuf[len],"DeviceName:",11))	{		len += 11;		len += SetOnlyCopyStr(&InBuf[len],SysInfo.DeviceName,MAXDEVICENAME);		}	else	{		goto ANALYDATAEND;	}	//GprsMode:	if(SaveIntData(&InBuf[len],"GprsMode:",(u32*)&SysInfo.GprsMode,&len,9))	{		goto ANALYDATAEND;	}	//GprsApn:	if(SaveStrData(&InBuf[len],"GprsApn",SysInfo.GprsApn,MAXGPRSAPN,&len,8))	{		goto ANALYDATAEND;	}		//GprsUsr:	if(SaveStrData(&InBuf[len],"GprsUsr:",SysInfo.GprsUsr,MAXGPRSUSR,&len,8))	{		goto ANALYDATAEND;	}	//GprsPwd:	if(SaveStrData(&InBuf[len],"GprsPwd:",SysInfo.GprsPwd,MAXGPRSUSR,&len,8))	{		goto ANALYDATAEND;	}	//GprsIP:	if(SaveStrData(&InBuf[len],"GprsIP:",SysInfo.GprsServerIP,MAXGPRSIP,&len,7))	{		goto ANALYDATAEND;	}	//GprsPort:	if(SaveIntData(&InBuf[len],"GprsPort:",(u32*)&SysInfo.GprsServerPort,&len,9))	{		goto ANALYDATAEND;	}		//GprsBeatHeart:60,	if(SaveIntData(&InBuf[len],"GprsBeatHeart:",(u32*)&SysInfo.GprsBeatHeart,&len,14))	{		goto ANALYDATAEND;	}	//GprsFreeOffline:120,	if(SaveIntData(&InBuf[len],"GprsFreeOffline:",(u32*)&SysInfo.GprsFreeOffline,&len,16))	{		goto ANALYDATAEND;	}	//GprsRetryCnt:3,	if(SaveIntData(&InBuf[len],"GprsRetryCnt:",(u32*)&SysInfo.GprsRetryCnt,&len,13))	{		goto ANALYDATAEND;	}		//GprsRegDat:,	if(SaveStrData(&InBuf[len],"GprsRegDat:",SysInfo.GprsRegDat,MAXREGDAT,&len,11))	{		goto ANALYDATAEND;	}	SysInfo.GprsRegDat[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.GprsRegDat);	//GprsServerAckReg:,	if(SaveStrData(&InBuf[len],"GprsServerAckReg:",SysInfo.GprsServerAckReg,MAXREGDAT,&len,17))	{		goto ANALYDATAEND;	}	SysInfo.GprsServerAckReg[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.GprsServerAckReg);	//GprsServerKickOff:,	if(SaveStrData(&InBuf[len],"GprsServerKickOff:",SysInfo.GprsServerKickOff,MAXREGDAT,&len,18))	{		goto ANALYDATAEND;	}	SysInfo.GprsServerKickOff[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.GprsServerKickOff);	//GprsHeartCont:	if(SaveStrData(&InBuf[len],"GprsHeartCont:",SysInfo.GprsHeartCont,MAXREGDAT,&len,14))	{		goto ANALYDATAEND;	}	SysInfo.GprsHeartCont[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.GprsHeartCont);	//GprsServerAckHeart:	if(SaveStrData(&InBuf[len],"GprsServerAckHeart:",SysInfo.GprsServerAckHeart,MAXREGDAT,&len,19))	{		goto ANALYDATAEND;	}	SysInfo.GprsServerAckHeart[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.GprsServerAckHeart);		if(SaveIntData(&InBuf[len],"GprsDatType:",(u32*)&SysInfo.GprsDatType,&len,12))	{		goto ANALYDATAEND;	}	//GprsRegMode:2,	if(SaveIntData(&InBuf[len],"GprsRegMode:",(u32*)&SysInfo.GprsRegMode,&len,12))	{		goto ANALYDATAEND;	}	//Rj45Mode:0,	if(SaveIntData(&InBuf[len],"Rj45Mode:",(u32*)&SysInfo.Rj45Mode,&len,9))	{		goto ANALYDATAEND;	}	//Dhcp:	if(SaveIntData(&InBuf[len],"Dhcp:",(u32*)&SysInfo.Dhcp,&len,5))	{		goto ANALYDATAEND;	}		//LocalIp:-1062731271,	len += 8;	len += SetCopyIp(&InBuf[len],SysInfo.LocalIp);	//LocalPort:502,	if(SaveIntData(&InBuf[len],"LocalPort:",(u32*)&SysInfo.LocalPort,&len,10))	{		goto ANALYDATAEND;	}	//SubNetMask:,	len += 11;	len += SetCopyIp(&InBuf[len],SysInfo.SubNetMask);	//GateIp:,	len += 7;	len += SetCopyIp(&InBuf[len],SysInfo.GateIp);	//DNSIP1:,	len += 7;	len += SetCopyIp(&InBuf[len],SysInfo.DnsIp1);	//DNSIP2:,	len += 7;	len += SetCopyIp(&InBuf[len],SysInfo.DnsIp2);	//EthTarIP:192.168.1.115????????????????????<,	if(SaveStrData(&InBuf[len],"EthTarIP:",SysInfo.EthTarIP,MAXGPRSIP,&len,9))	{		goto ANALYDATAEND;	}	//EthTarTCPPort:8080,	if(SaveIntData(&InBuf[len],"EthTarTCPPort:",(u32*)&SysInfo.EthTarTcpPort,&len,14))	{		goto ANALYDATAEND;	}	//EthBeatHeart:60,	if(SaveIntData(&InBuf[len],"EthBeatHeart:",(u32*)&SysInfo.EthBeatHeart,&len,13))	{		goto ANALYDATAEND;	}	//EthFreeOffline:120,	if(SaveIntData(&InBuf[len],"EthFreeOffline:",(u32*)&SysInfo.EthFreeOffline,&len,15))	{		goto ANALYDATAEND;	}		//EthRetryCnt:3,	if(SaveIntData(&InBuf[len],"EthRetryCnt:",(u32*)&SysInfo.EthRetryCnt,&len,12))	{		goto ANALYDATAEND;	}	//EthRegDat:,	if(SaveStrData(&InBuf[len],"EthRegDat:",SysInfo.EthRegDat,MAXREGDAT,&len,10))	{		goto ANALYDATAEND;	}	SysInfo.EthRegDat[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.EthRegDat);		//EthServerAckReg:,	if(SaveStrData(&InBuf[len],"EthServerAckReg:",SysInfo.EthServerAckReg,MAXREGDAT,&len,16))	{		goto ANALYDATAEND;	}	SysInfo.EthServerAckReg[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.EthServerAckReg);	//EthServerKickOff:,	if(SaveStrData(&InBuf[len],"EthServerKickOff:",SysInfo.EthServerKickOff,MAXREGDAT,&len,17))	{		goto ANALYDATAEND;	}	SysInfo.EthServerKickOff[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.EthServerKickOff);	//EthHeartCont:ACK,	if(SaveStrData(&InBuf[len],"EthHeartCont:",SysInfo.EthHeartCont,MAXREGDAT,&len,13))	{		goto ANALYDATAEND;	}	SysInfo.EthHeartCont[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.EthHeartCont);	//EthServerAckHeart:,	if(SaveStrData(&InBuf[len],"EthServerAckHeart:",SysInfo.EthServerAckHeart,MAXREGDAT,&len,18))	{		goto ANALYDATAEND;	}	SysInfo.EthServerAckHeart[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.EthServerAckHeart);	if(SaveIntData(&InBuf[len],"EthDatType:",(u32*)&SysInfo.EthDatType,&len,11))	{		goto ANALYDATAEND;	}		//EthRegMode:2,	if(SaveIntData(&InBuf[len],"EthRegMode:",(u32*)&SysInfo.EthRegMode,&len,11))	{		goto ANALYDATAEND;	}	//MqttSubTopic:,	if(SaveStrData(&InBuf[len],"MqttSubTopic:",SysInfo.MqttSubTopic,MAXREGDAT,&len,13))	{		goto ANALYDATAEND;	}	SysInfo.MqttSubTopic[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.MqttSubTopic);	//MqttPubtopic:,	if(SaveStrData(&InBuf[len],"MqttPubTopic:",SysInfo.MqttPubTopic,MAXREGDAT,&len,13))	{		goto ANALYDATAEND;	}	SysInfo.MqttPubTopic[SYS_TXT_DATLEN] = strlen((const char *)SysInfo.MqttPubTopic);	//MqttDeviceId:,	if(CompStr(&InBuf[len],"MqttDeviceId:",13))	{				len += 13;		len += SetOnlyCopyStr(&InBuf[len],SysInfo.MqttDeviceID,MQTT_PWD);		}	else	{		goto ANALYDATAEND;	}	SysInfo.MqttDeviceID[MQT_TXT_DATLEN] = strlen((const char *)SysInfo.MqttDeviceID);	//MqttUserName:,	if(SaveStrData(&InBuf[len],"MqttUserName:",SysInfo.MqttUserName,MQTT_PWD,&len,13))	{		goto ANALYDATAEND;	}	SysInfo.MqttUserName[MQT_TXT_DATLEN] = strlen((const char *)SysInfo.MqttUserName);	//MqttPwd:,	if(SaveStrData(&InBuf[len],"MqttPwd:",SysInfo.MqttPwd,MQTT_PWD,&len,8))	{		goto ANALYDATAEND;	}	SysInfo.MqttPwd[MQT_TXT_DATLEN] = strlen((const char *)SysInfo.MqttPwd);	//MqttRepTim:0,	if(SaveIntData(&InBuf[len],"MqttRepTim:",(u32*)&SysInfo.MqttRepTim,&len,11))	{		goto ANALYDATAEND;	}	if(SysInfo.MqttRepTim < 3)	{		SysInfo.MqttRepTim = 3;	}		//MqttRepData:0,	if(SaveIntData(&InBuf[len],"MqttRepData:",(u32*)&SysInfo.MqttRepData,&len,12))	{		goto ANALYDATAEND;	}		//AliyunSet:0,	if(SaveIntData(&InBuf[len],"AliyunSet:",(u32*)&SysInfo.AliyunSet,&len,10))	{		goto ANALYDATAEND;	}		//ProductKey:0,	if(SaveStrData(&InBuf[len],"ProductKey:",SysInfo.ProductKey,MAXGPRSUSR,&len,11))	{		goto ANALYDATAEND;	}		//nameCould:0,	if(SaveStrData(&InBuf[len],"nameCould:",SysInfo.DeviceName_Could,HW_DEVSECRET_LEN,&len,10))	{		goto ANALYDATAEND;	}	//DeviceSecret:0,	if(SaveStrData(&InBuf[len],"DeviceSecret:",SysInfo.DeviceSecret,MAXGPRSUSR,&len,13))	{		goto ANALYDATAEND;	}	//HWDevId:0,	if(SaveStrData(&InBuf[len],"HWDevId:",SysInfo.HWDevId,MAXGPRSIP,&len,8))	{		goto ANALYDATAEND;	}	//HWDevSecret:0,	if(SaveStrData(&InBuf[len],"HWDevSecret:",SysInfo.HWDevSecret,HW_DEVSECRET_LEN,&len,12))	{		goto ANALYDATAEND;	}	//HWSerId:0,	if(SaveStrData(&InBuf[len],"HWSerId:",SysInfo.HWSerId,MQTT_PWDLEN_MAX,&len,8))	{		goto ANALYDATAEND;	}	//HWServer:0,	if(SaveStrData(&InBuf[len],"HWServer:",SysInfo.HWServer,MAXGPRSIP,&len,9))	{		goto ANALYDATAEND;	}	//Workfreq:1,	if(SaveIntData(&InBuf[len],"Workfreq:",(u32*)&SysInfo.Workfreq,&len,9))	{		goto ANALYDATAEND;	}		//TerminalRepCycle:1	if(SaveIntData(&InBuf[len],"TerminalRepCycle:",(u32*)&SysInfo.TerminalRepCycle,&len,17))	{		goto ANALYDATAEND;	}	//NetLinkPriority:0	if(SaveIntData(&InBuf[len],"NetLinkPriority:",(u32*)&SysInfo.NetLinkPriority,&len,16))	{		goto ANALYDATAEND;	}	SaveSysInfo();	if(tempWorkfreq != SysInfo.Workfreq)	{		freqChangeFlag = 1;		//异或交换数据		tempWorkfreq = tempWorkfreq ^ SysInfo.Workfreq;		SysInfo.Workfreq = tempWorkfreq ^ SysInfo.Workfreq;		tempWorkfreq = tempWorkfreq ^ SysInfo.Workfreq;		freqChangeTim = calendar.min;	}	ReplySetOK();	return 1;ANALYDATAEND:	ReadSysInfo();	ReplySetErr();	return 0;}u8 CompareDevInfo(TERMINALINFO_WT2 dev1,TERMINALINFO_WT2 dev2){	if(dev1.deviceId != dev2.deviceId)	{		return 1;	}	for(u8 i = 0; i < 7; i++)	{		if(dev1.HighLim[i] != dev2.HighLim[i])		{			return 1;		}		if(dev1.LowLim[i] != dev2.LowLim[i])		{			return 1;		}		if(!CompStr(dev1.name[i],dev2.name[i],sizeof(dev2.name[i])))		{			return 1;		}	}	if(dev1.Type != dev2.Type)	{		return 1;	}	for(u8 i = 0; i < 6; i++)	{		if(dev1.uniId[i] != dev2.uniId[i])		{			return 1;		}	}		return 0;}void CopyDevInfo(TERMINALINFO_WT2 *dev1,TERMINALINFO_WT2 dev2){	dev1->deviceId = dev2.deviceId;	for(u8 i = 0; i < 7; i++)	{		dev1->HighLim[i] = dev2.HighLim[i];		dev1->LowLim[i] = dev2.LowLim[i];		CopyStr(dev1->name[i],dev2.name[i],DESCRIBE_NAME_LEN);	}	CopyStr(dev1->devName,dev2.devName,DESCRIBE_DEVICE);	dev1->Type = dev2.Type;	for(u8 i = 0; i < 6; i++)	{		dev1->uniId[i] = dev2.uniId[i];	}}/*	设置设备ID为Index 的终端设备信息	W2为: WT107,108,109,102信息	Index			 当前的坐标	mode			是否直接写入 1： 直接写入flash 0：匹配节点再写入*/u8 SetTerminalW2Info(u8 Index,u8 *InBuf,u8 mode){	u16 len = 0;	DevInfo[Index].deviceId = Index+1;	DevInfo[Index].uniId[0] = InBuf[len++];	DevInfo[Index].uniId[1] = InBuf[len++];	DevInfo[Index].uniId[2] = InBuf[len++];	DevInfo[Index].uniId[3] = InBuf[len++];	DevInfo[Index].uniId[4] = InBuf[len++];	DevInfo[Index].uniId[5] = InBuf[len++];	len++;	len += SetOnlyCopyStr(&InBuf[len],DevInfo[Index].devName,DESCRIBE_DEVICE);	len += SetOnlyCopyStr(&InBuf[len],DevInfo[Index].name[0],DESCRIBE_NAME_LEN);	len += SetOnlyCopyStr(&InBuf[len],DevInfo[Index].name[1],DESCRIBE_NAME_LEN);	len += SetOnlyCopyStr(&InBuf[len],DevInfo[Index].name[2],DESCRIBE_NAME_LEN);	len += SetOnlyCopyStr(&InBuf[len],DevInfo[Index].name[3],DESCRIBE_NAME_LEN);	len += SetOnlyCopyStr(&InBuf[len],DevInfo[Index].name[4],DESCRIBE_NAME_LEN);	len += SetOnlyCopyStr(&InBuf[len],DevInfo[Index].name[5],DESCRIBE_NAME_LEN);	len += SetOnlyCopyStr(&InBuf[len],DevInfo[Index].name[6],DESCRIBE_NAME_LEN);	DevInfo[Index].Type = (InBuf[len++] - '0') * 10;	DevInfo[Index].Type += InBuf[len] - '0';	len += 2;		//预警上线设置	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].HighLim[0]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].HighLim[1]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].HighLim[2]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].HighLim[3]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].HighLim[4]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].HighLim[5]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].HighLim[6]);	//预警下线设置	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].LowLim[0]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].LowLim[1]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].LowLim[2]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].LowLim[3]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].LowLim[4]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].LowLim[5]);	len += SetCopyNum(&InBuf[len],(u32*)&DevInfo[Index].LowLim[6]);	if(mode == 0)	{		TERMINALINFO_WT2 dev1;		CopyDevInfo(&dev1,DevInfo[Index]);		//当前修改的ID不一致		if(DownLoad2TerminalWT2(Index+1,2,0) == 1)		{			SaveDevWT2Config(Index);			if(CompareDevInfo(DevInfo[Index],dev1))			{//写一个复制函数				CopyDevInfo(&DevInfo[Index],dev1);			}			ChangeTempDevID(&DevInfo[Index].uniId[0],DevInfo[Index].Type,Index+1);			DevInfo[Index].isExist = 1;			ReplySetOK();			return 1;		}		else		{//失败原因: 设置时间到了 或者芯片ID错(小概率)			ReadDevWT2Config(Index);			ReplySetErr();			return 0;		}	}	else	{		SaveDevWT2Config(Index);		DevInfo[Index].isExist = 0;		ReplySetOK();		return 1;	}}u8 FindFreeIndex(void){	u8 index = DEVICE_MAX;	for(u8 i = 0; i < DEVICE_MAX;i++)	{		if(DevInfo[i].deviceId > DEVICE_MAX || DevInfo[i].deviceId == 0)		{			index = i;			break;		}	}	return index;}/*	获取终端设备数组下标 以及 设备ID*/u8 GetDevIndex(u8 *InBuf,u8 *Index,u8 *devId){	if(InBuf[0] >= '0' && InBuf[0] <= '9')	{//代表ID号   小于50		*devId = (InBuf[0] - '0') * 10 + (InBuf[1] - '0');		if(*Index != 0xFF)		{			*Index = FindFreeIndex();		}		return 1;	}	return 0;}/*	设置WT100 配置信息*/void SetTerminalW1Info(u8 devId,u8 *InBuf){	if(DownLoad2TerminalWT1(devId,InBuf) == 1)	{		ChangeTempDevID(&InBuf[0],DEV_WT100,devId);		ReplySetOK();	}	else 	{		ReplySetErr();	}}/*	打印历史记录*/void DebugHistory(HISTORY *history){	u8 *buf = malloc(80);	SendString("\r\n{\"MSGTYPE\":4,\"MSG\":{");	sprintf((char*)buf,"\"year_month_day\":\"%d-%d-%d\",",history->year,history->mon,history->day);	SendString(buf);	sprintf((char*)buf,"\"hour_min_sec\":\"%d:%d:%d\",\r\n",history->hour,history->min,history->sec);	SendString(buf);	sprintf((char*)buf,"\"BatVal\":%d,\"GSM\":%d,\r\n",history->BatVal,history->GsmVal);	SendString(buf);	sprintf((char*)buf,"\"DeviceID\":%d,",history->DeviceId);	SendString(buf);	sprintf((char*)buf,"\"DevType\":%d,\"Illu\":%d,\r\n",history->DevType,history->Illu);	SendString(buf);	sprintf((char*)buf,"\"Temp\":%d,\"Humi\":%d,\r\n",history->Temp,history->Humi);	SendString(buf);	sprintf((char*)buf,"\"Co2\":%d,\"Tvoc\":%d,\r\n",history->Co2,history->Tvoc);	SendString(buf);	sprintf((char*)buf,"\"SoilHumi\":%d,\"SoilTemp\":%d}}\r\n",history->SoilHumi,history->SoilTemp);	SendString(buf);	free(buf);}/*	获取寄存器数据*/void GetTerminalRegData(u8 mode){	static u8 readDevPtr = 0;	u8 isLast = 0,nextPtr = 0;	if(mode == 0)	{		readDevPtr = 0;		return;	}		isLast = GetDevOnlineIndex(&readDevPtr,&nextPtr);	if(isLast == 1 && readDevPtr == 0)	{		if(nextPtr == 0)		{			SendString("{}");		}		else		{			GetTerminalW2Info(readDevPtr,1,1);		}	}	else if(isLast)	{		GetTerminalW2Info(readDevPtr,1,1);		readDevPtr = 0;	}	else	{		GetTerminalW2Info(readDevPtr,1,0);		readDevPtr = nextPtr;	}}/*	读取历史记录*/void GetAlarmHistory(u8 mode){	u16 Cnt = historyCnt;	u16 ptr;	u8 *buf = malloc(20);	if(mode)	{		sprintf((char*)buf,"{\"Total\":%d",historyCnt);	}	else	{		Cnt = alarmCnt;		sprintf((char*)buf,"{\"Total\":%d",alarmCnt);	}	SendString(buf);	for(ptr = 0; ptr < Cnt; ptr++)	{//打印存在的历史记录		ReadHistroy((u8*)&History,ptr,mode);		if(History.DeviceId > 0 && History.DeviceId <= DEVICE_MAX)		{			SendString(",\r\n");			DebugHistory(&History);			DevDBTime = GetSysTimCnt();		}		if(sendStop)		{			sendStop = 0;			break;		}	}	PutInUart0('}');	free(buf);}/*	相同返回0 否则 1*/u8 CheckDevUId(u8 Index,u8* uId){	u8 rec = 0;	for(u8 i = 0; i < 6; i++)	{		if(DevInfo[Index].uniId[i] != uId[i])		{			rec = 1;			break;		}	}	return rec;}/*	串口命令*/void PcCmdPro(void){	static u8 devIndex = 0;	u8 devId = 0;	u8 Index = 0;			u8 i;	u8 bufIndex = 4;		if(usart_Frame.recFlag == 0)	{//串口还没有接收到数据		if(ABSVALUE(GetSysTimCnt(),DevDBTime) > 400)		{//6s没接收到串口数据 开启DEBUG			DB_Flag = 1;		}		return;	}	usart_Frame.recBuf[usart_Frame.recLen] = '\0';		for(i = 0; i < 4; i++)	{//校验密码		if(usart_Frame.recBuf[i + 1] != SysInfo.PassCode[i])		{			break;		}	}	if(i < 4)	{		if(CompStr(&usart_Frame.recBuf[1],"ASDFGHJKL",9))		{			bufIndex = 9;		}		else		{			ReplySetErr();			goto CLEARFLAG; 				}	}	DevDBTime = GetSysTimCnt();	DB_Flag = 0;	if(usart_Frame.recBuf[bufIndex+1] == '\0')	{		ReplySetOK();		goto CLEARFLAG; 	}	//判断指令	switch(usart_Frame.recBuf[bufIndex+1])	{		case READ_ALL:			//读取参数			DebugSysInfo();		break;		case READ_TIME:			//读取设备时间			ReplyDeviceTim();		break;		case SET_TIME:			//设置设备时间			SetDeviceTime(&usart_Frame.recBuf[bufIndex+2]);			ReplySetOK();		break;		case SET_PWD: 			//修改密码			SetDevicePwd(&usart_Frame.recBuf[bufIndex+2]);		break;		/*		case READ_VER:		{			//读取版本号			usart_Frame.recLen = 0;			usart_Frame.recLen = sprintf((char*)usart_Frame.recBuf,"{\"MSGTYPE\":4,\"MSG\":{");			usart_Frame.recLen += sprintf((char*)&usart_Frame.recBuf[usart_Frame.recLen],"\"deviceMode\":\"%s\",",UserInfo.version);			usart_Frame.recLen += sprintf((char*)&usart_Frame.recBuf[usart_Frame.recLen],"\"version\":\"%s\",",version);			usart_Frame.recLen += sprintf((char*)&usart_Frame.recBuf[usart_Frame.recLen],"\"imei\":\"%s\",",g_IMEI);			usart_Frame.recLen += sprintf((char*)&usart_Frame.recBuf[usart_Frame.recLen],"\"siglevel\":%d}}",g_SigLevel);					usart_Frame.sendFlag = 1;		}		break;		*/		case RESTART:		{			//重启			UserInfo.isReboot = 0x1234;			SaveUserInfo();			NVIC_SystemReset();		}		break;		case SET_RST:		{			//恢复出厂			SetSysInfoDef();			ReplySetOK();			break;		}		case SET_ALL://写入参数		{			if(SetDevicePara(&usart_Frame.recBuf[bufIndex+2]))			{				//需要设置APN				NeedSetAPN = 1;				NeedOffline = 1;				InitLocalIP(0);				NetSelected = SysInfo.NetLinkPriority;			}			break;		}		case READ_DEV://读取配置WT107		{			if(GetDevIndex(&usart_Frame.recBuf[bufIndex+2],&devIndex,&devId) != 0xFE)			{//找到设备ID为devId的数组下标				if(devIndex == DEVICE_MAX)				{//设备ID 已满					sprintf((char *)usart_Frame.recBuf,"{\"MSGTYPE\":2}\r\n");					usart_Frame.sendFlag = 1;				}				else				{//需要判断MAC地址是否一致					if(!CheckDevUId(devId-1,&usart_Frame.recBuf[bufIndex+5]))					{//MAC相等						devIndex = devId-1;					}					else					{						for(u8 i = 0; i < DEVICE_MAX;i++)						{							if(DevInfo[i].deviceId > 0 && DevInfo[i].deviceId < DEVICE_MAX)							{								if(!CheckDevUId(i,&usart_Frame.recBuf[bufIndex+5]))								{//MAC相等									devIndex = i;									break;								}							}						}					}					//找到对应的设备信息					GetTerminalW2Info(devIndex,0,0);				}			}			break;		}		case SET_DEV://写入配置WT107		{			Index = 0xFF;			if(GetDevIndex(&usart_Frame.recBuf[bufIndex+2],&Index,&devId))			{//Index 获取到的是原有数组下标 或者新建空闲下标				if(DevInfo[devId-1].deviceId > 0 && DevInfo[devId-1].deviceId < DEVICE_MAX+1)				{//设备存在 1.是不是本台设备 2.是不是覆盖设备					if(!CheckDevUId(devId-1,&usart_Frame.recBuf[bufIndex+5]))					{						SetTerminalW2Info(devId-1,&usart_Frame.recBuf[bufIndex+5],0);					}					else					{						if(CompStr(&usart_Frame.recBuf[bufIndex+5],"q,",2))						{							SetTerminalW2Info(devId-1,&usart_Frame.recBuf[bufIndex+7],0);						}						else						{							sprintf((char *)usart_Frame.recBuf,"CONFIRM\r\n");							usart_Frame.sendFlag = 1;						}					}				}				else				{//设备不存在 直接写入					SetTerminalW2Info(devId-1,&usart_Frame.recBuf[bufIndex+5],0);				}								if(devIndex != devId-1)				{//ID改变了					DelDevWT2Config(devIndex);				}			}			break;		}		case DEL_DEV://删除配置WT107		{			Index = 0xFF;			if(GetDevIndex(&usart_Frame.recBuf[bufIndex+2],&Index,&devId))			{				DelDevWT2Config(devId-1);				ReplySetOK();			}			break;		}		case SET_DEVALL:		{			if(GetDevIndex(&usart_Frame.recBuf[bufIndex+2],&Index,&devId))			{				SetTerminalW2Info(devId-1,&usart_Frame.recBuf[bufIndex+5],1);			}			break;		}		case READ_DEVALL://读取所有终端配置		{			PutInUart0('{');			i = 0;			for(u8 j = 0; j < DEVICE_MAX; j++)			{				if(DevInfo[j].deviceId > 0 && DevInfo[j].deviceId <= DEVICE_MAX)				{					if(i != 0)					{						SendString(",\r\n");					}					i++;					GetTerminalW2Info(j,0,0);				}			}			PutInUart0('}');			if(i == 0)			{				DevInfoInit();			}			break;		}		case READ_DEVREG://读取寄存器当前值  即读取在线设备		{			GetTerminalRegData(1);			break;		}		case STOP_DEVREG: //停止读取设备			GetTerminalRegData(0);			ReplySetOK();			break;		case SET_DEVWT1://写入配置WT100		{			if(usart_Frame.recBuf[bufIndex+2] >= '0' && usart_Frame.recBuf[bufIndex+2] <= '9')			{//代表ID号   小于50				devId = usart_Frame.recBuf[bufIndex+2] - '0'; 				devId = devId * 10 + (usart_Frame.recBuf[bufIndex+3] - '0'); 				SetTerminalW1Info(devId,&usart_Frame.recBuf[bufIndex+5]);			}			break;		}		case READ_HIS://读取历史			GetAlarmHistory(1);			break;		case CLEAR_HIS://删除记录			ClearHistory(1);			ReplySetOK();			break;		case READ_ALARM://读取历史			GetAlarmHistory(0);			break;		case CLEAR_ALARM://删除记录			ClearHistory(0);			ReplySetOK();			break;		case SET_MSG://设置中英文			if(usart_Frame.recBuf[bufIndex+2] >= '0' && usart_Frame.recBuf[bufIndex+2] <= '1')			{				UserInfo.isChinese = usart_Frame.recBuf[bufIndex+2] - '0';				SaveUserInfo();				ReplySetOK();			}			else			{				ReplySetErr();			}			break;		case SET_DEVONLINE://开启设备上线更新			PrintNewDev();		break;		case 0x49:			printf("SMSFlag:%d",SMSFlag);		break;		case SET_VER:			for(u8 i = bufIndex+2; i < 17 && i < usart_Frame.recLen; i++)			{				UserInfo.version[i - 6] = usart_Frame.recBuf[i];			}			SaveUserInfo();		break;		default:			ReplySetErr();			break;	}	CLEARFLAG:	if(usart_Frame.sendFlag == 1)	{//数据需要发送		usart_Frame.sendFlag = 0;		SendString(usart_Frame.recBuf);	}	usart_Frame.recFlag = 0;	usart_Frame.recLen = 0;}/*	上传新开机设备信息 让上位机进行配置*/void PrintNewDev(void){	u8 *buf = malloc(80);	sprintf((char*)buf,"{\"Total\":%d",devPtr);	SendString(buf);	if(devPtr > 0)	{		for(u8 i = 0,k = 0; i < 25; i++)		{			if(tempDev[i].avaliable == 1)			{				sprintf((char*)buf,",{\"MSG\":{\"DevID\":%d,\"DevUid\":\"",tempDev[i].Id);				SendString(buf);					for(u8 j = 0; j < 6; j++)				{					sprintf((char*)&buf[2*j],"%02X",tempDev[i].uId[j]);				}				SendString(buf);				sprintf((char*)buf,"\",\"type\":%d,\"isNode\":%d,",tempDev[i].type,tempDev[i].isNode);				SendString(buf);				sprintf((char*)buf,"\"baud\":%d,\"dataLen\":%d,",tempDev[i].baud,tempDev[i].dataLen);				SendString(buf);				sprintf((char*)buf,"\"verifyType\":%d,\"stopLen\":%d}}\r\n",tempDev[i].verifyType,tempDev[i].stopLen);				SendString(buf);				k++;			}			if(k >= devPtr)			{				break;			}		}	}	SendString("}");	free(buf);}